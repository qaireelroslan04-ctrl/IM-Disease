<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IM Disease</title>

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- 1. DESIGN SYSTEM --- */
        :root {
            --bg-body: #000000; --bg-sidebar: #050505; --bg-card: #0a0a0a; --bg-box: #111111; --bg-input: #171717;
            --border-color: #27272a; --text-main: #e2e8f0; --text-muted: #94a3b8;
            --accent-color: #3b82f6; --accent-bg: #172554; --accent-text: #bfdbfe;
            --header-bg: rgba(0, 0, 0, 0.95);
            --sidebar-width: 300px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { background-color: var(--header-bg); padding: 0 1rem; height: 60px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); z-index: 50; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { font-size: 1.2rem; cursor: pointer; }
        .app-title { font-size: 1.1rem; font-weight: 800; color: var(--accent-color); white-space: nowrap; cursor: pointer;}
        .version-badge {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-left: 8px;
            padding: 2px 6px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            opacity: 0.7;
            letter-spacing: 0.5px;
        }
        
        /* Admin Badge */
        .admin-badge { 
            background: var(--accent-color); color: white; padding: 2px 6px; border-radius: 4px; 
            font-size: 0.6rem; font-weight: 800; letter-spacing: 1px; display: none; margin-right: 10px;
        }

        /* User Avatar */
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border-color); cursor: pointer; }
        
        /* --- LAYOUT --- */
        #app-container { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* --- HOME VIEW --- */
        #home-view { 
            position: absolute; inset: 0; z-index: 60; background: var(--bg-body);
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            gap: 2rem; padding: 2rem; overflow-y: auto; 
        }
        .menu-list { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 400px; }
        .menu-item-home { 
            display: flex; align-items: center; justify-content: space-between; padding: 1.2rem 1.5rem; 
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.75rem; 
            cursor: pointer; transition: transform 0.1s;
        }
        .menu-item-home:active { transform: scale(0.98); }
        .menu-text { display: flex; flex-direction: column; }
        .menu-label { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .menu-sub { font-size: 0.8rem; color: var(--text-muted); }

        /* --- SIDEBAR (Retractable) --- */
        aside { 
            width: var(--sidebar-width); background: var(--bg-sidebar); 
            border-right: 1px solid var(--border-color); display: flex; flex-direction: column; 
            transition: width 0.3s ease, transform 0.3s ease; z-index: 40;
            position: relative; 
            overflow: hidden; 
            white-space: nowrap; /* Prevents text wrapping during collapse */
        }
        aside.collapsed { width: 0; border: none; }
        
        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .search-input { width: 100%; padding: 0.6rem; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); border-radius: 0.5rem; outline: none; }
        
        .sidebar-content { flex: 1; overflow-y: auto; padding-bottom: 2rem; }
        
        /* Categories & Items */
        .category-group { margin-bottom: 10px; }
        .category-header { 
            font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; 
            padding: 10px 15px; letter-spacing: 1px; user-select: none;
        }
        .disease-item {
            padding: 10px 15px; cursor: pointer; border-left: 3px solid transparent; 
            font-size: 0.9rem; color: var(--text-main); transition: background 0.2s;
        }
        .disease-item:hover { background: var(--bg-input); }
        .disease-item.active { background: var(--bg-input); border-left-color: var(--accent-color); font-weight: 600; }
        .sortable-ghost { opacity: 0.4; background: var(--bg-input); }

       /* Sidebar Toggle Btn (Floating) */
        .sidebar-toggle {
            position: absolute; bottom: 20px; left: 300px; /* Matches --sidebar-width */
            width: 24px; height: 40px; 
            background: var(--bg-card); border: 1px solid var(--border-color); border-left: none;
            border-radius: 0 8px 8px 0; color: var(--text-muted);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 45; transition: left 0.3s ease, transform 0.3s;
        }
        .sidebar-toggle.collapsed { left: 0; transform: rotate(180deg); }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            aside { position: absolute; height: 100%; transform: translateX(-100%); width: 80%; }
            aside.open { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            
            /* FIX: Stable Toggle Button Styling */
            .sidebar-toggle { 
                display: flex; 
                position: fixed; /* Fixed to viewport */
                left: 0; 
                bottom: 80px; 
                width: 32px; height: 42px;
                
                /* Shape: Flat against left wall, Rounded on right */
                border-radius: 0 8px 8px 0;
                border: 1px solid var(--border-color);
                border-left: none; /* No border on the flat side */
                background: var(--bg-card);
                box-shadow: 2px 0 8px rgba(0,0,0,0.3);
                
                align-items: center; justify-content: center;
                transition: left 0.3s ease; /* Animate position only */
            }
            
            /* When Sidebar is Open */
            .sidebar-toggle.mobile-open {
                left: 80%; /* Move to right edge of sidebar */
            }

            /* Rotate ONLY the arrow text, not the box */
            .sidebar-toggle div {
                transition: transform 0.3s;
                transform: rotate(180deg); /* Default: Points Right (>) for "Open Me" */
            }
            .sidebar-toggle.mobile-open div {
                transform: rotate(0deg); /* Open: Points Left (<) for "Close Me" */
            }

            .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 35; }
            .backdrop.open { display: block; }
        }

        /* --- MAIN CONTENT --- */
        main { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); overflow: hidden; position: relative; }
        
        .welcome-msg { margin: auto; text-align: center; color: var(--text-muted); }
        
        /* Details View */
        #caseDetails { display: none; flex-direction: column; height: 100%; }
        
        /* Search for .details-header and REPLACE it with this: */
        .details-header { 
            padding: 1.5rem 2rem; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
        }
        .cat-badge { font-size: 0.7rem; color: var(--accent-color); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .main-title { font-size: 1.8rem; font-weight: 800; margin-top: 5px; color: white; }

        /* Modern Tabs (Pills) */
        .tabs-container { 
            padding: 10px 2rem; border-bottom: 1px solid var(--border-color); 
            display: flex; gap: 10px; overflow-x: auto; background: var(--bg-body);
        }
        .tab-pill {
            padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            background: var(--bg-input); color: var(--text-muted); cursor: pointer; border: 1px solid transparent;
            white-space: nowrap; transition: all 0.2s;
        }
        .tab-pill:hover { background: var(--bg-box); color: var(--text-main); }
        .tab-pill.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .add-tab-btn {
            width: 30px; height: 30px; border-radius: 50%; border: 1px dashed var(--text-muted);
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; color: var(--text-muted);
        }

        /* --- EDITOR & CONTENT --- */
        .content-area { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        
        /* Editor Container */
        .editor-container { 
            max-width: 800px; margin: 0 auto; width: 100%; padding: 2rem; 
            flex: 1; display: flex; flex-direction: column; 
        }

        /* Note Title */
        .note-title-input {
            width: 100%; background: transparent; border: none; color: var(--text-main);
            font-size: 2rem; font-weight: 800; font-family: -apple-system, sans-serif; 
            margin-bottom: 16px; line-height: 1.2; outline: none;
        }

        /* The Actual Editor */
        .note-content { 
            font-size: 1rem; line-height: 1.6; color: var(--text-main); min-height: 60vh; 
            outline: none;
        }
        .note-content:empty:before { content: 'Start writing...'; color: var(--text-muted); opacity: 0.5; }

        /* Floating Toolbar (Sticky) */
        .editor-toolbar {
            display: none; align-items: center; gap: 4px; padding: 8px 16px;
            background: var(--bg-card); border-bottom: 1px solid var(--border-color);
            overflow-x: auto; white-space: nowrap; position: sticky; top: 0; z-index: 30;
        }
        .editor-toolbar.visible { display: flex; }

        .fmt-btn {
            background: transparent; border: 1px solid transparent; color: var(--text-muted);
            cursor: pointer; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.85rem;
        }
        .fmt-btn:hover { background: var(--bg-input); color: var(--text-main); }
        .fmt-btn.active { background: rgba(59, 130, 246, 0.2); color: var(--accent-color); border-color: var(--accent-color); }

        /* Search Results (in Sidebar) */
        .search-result-item { padding: 10px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .search-result-item:hover { background: var(--bg-input); }
        .result-path { font-size: 0.65rem; color: var(--accent-color); opacity: 0.8; }
        .result-title { font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        .result-snippet { font-size: 0.75rem; color: var(--text-muted); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        mark { background: rgba(59, 130, 246, 0.3); color: white; padding: 0 2px; border-radius: 2px; }

        /* --- CONTEXT MENU --- */
        #contextMenu {
            position: fixed; display: none; background: var(--bg-card); 
            border: 1px solid var(--border-color); border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 9999;
            min-width: 150px; overflow: hidden; padding: 5px;
        }
        .ctx-item { 
            padding: 8px 12px; cursor: pointer; font-size: 0.9rem; color: var(--text-main); 
            border-radius: 4px; display: flex; align-items: center; gap: 8px;
        }
        .ctx-item:hover { background: var(--accent-color); color: white; }
        .ctx-item.delete:hover { background: #dc2626; }

        /* --- UNIVERSAL MODAL (Form) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
        }
        .modal-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            width: 90%; max-width: 400px; border-radius: 12px; padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: var(--text-main); }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .form-input, .form-select { 
            width: 100%; padding: 10px; background: var(--bg-input); border: 1px solid var(--border-color); 
            border-radius: 6px; color: white; outline: none; font-size: 0.95rem;
        }
        .form-input:focus { border-color: var(--accent-color); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-cancel { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }

        /* FAB */
        .fab {
            position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px;
            background: var(--accent-color); border-radius: 50%; color: white;
            display: none; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; z-index: 80;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            aside { position: absolute; height: 100%; transform: translateX(-100%); width: 80%; }
            aside.open { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            aside.collapsed .sidebar-toggle { display: none; } /* Hide toggle on mobile, use header btn */
            .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 35; }
            .backdrop.open { display: block; }
        }

        /* --- NEW: SCROLL & BOXES --- */
        /* Hide the redundant input title in editor */
        #note-title { display: none; }

        /* Colored Info Box Style */
        .info-box {
            background-color: rgba(59, 130, 246, 0.1); 
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
            margin: 10px 0;
            padding: 0;
            overflow: hidden;
        }
        .box-header {
            background-color: rgba(59, 130, 246, 0.2);
            padding: 8px 12px;
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.9rem;
        }
        .box-content {
            padding: 10px 12px;
            color: var(--text-main);
        }
    </style>
</head>
<body oncontextmenu="return false;"> <div id="contextMenu"></div>

    <header>
        <div class="header-left">
            <div class="logo-icon" onclick="goHome()">‚öïÔ∏è</div>
            <span class="app-title" onclick="goHome()">IM Disease</span>
            <span class="version-badge">v0.1.2</span>
        </div>
        <div style="display:flex; align-items:center;">
            <div id="adminBadge" class="admin-badge">ADMIN</div>
            <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&background=171717&color=fff" class="user-avatar" onclick="handleAuth()">
        </div>
    </header>

    <div id="app-container">
        
        <div id="home-view">
            <h2>Select Section</h2>
            <div id="homeList" class="menu-list"></div>
            <div id="homeFab" class="fab">+</div>
        </div>

        <div id="app-view" style="display:none; width:100%; height:100%;">
            <div class="backdrop" id="backdrop" onclick="toggleSidebar()"></div>
            
            <aside id="sidebar">
                <div class="sidebar-header">
                    <input type="text" id="searchSidebar" class="search-input" placeholder="Search...">
                </div>
                <div id="sidebarContent" class="sidebar-content"></div>
            </aside>
            <div class="sidebar-toggle" id="sidebarToggle" onclick="toggleRetract()"><div>‚ùÆ</div></div>

            <main>
                <div id="welcomeMsg" class="welcome-msg">Select a disease from the sidebar</div>
                
                <div id="caseDetails">
                    <div class="details-header">
                        <div>
                            <div id="detailCat" class="cat-badge">CATEGORY</div>
                            <div id="detailTitle" class="main-title">Disease Name</div>
                        </div>
                        <button class="icon-btn" onclick="toggleEditMode()" title="Edit Note">
                            <svg style="width:20px;height:20px;fill:currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        </button>
                    </div>
                    
                    <div class="tabs-container" id="tabsContainer">
                        </div>

                    <div id="editor-toolbar" class="editor-toolbar">
                        <button class="fmt-btn" onclick="fmt('bold')" title="Bold"><b>B</b></button>
                        <button class="fmt-btn" onclick="fmt('italic')" title="Italic"><i>I</i></button>
                        <button class="fmt-btn" onclick="fmt('underline')" title="Underline"><u>U</u></button>
                        
                        <span style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></span>
                        
                        <select onchange="fmt('fontSize', this.value)" class="fmt-btn" style="width:auto;">
                            <option value="3">Normal</option>
                            <option value="2">Small</option>
                            <option value="5">Big</option>
                            <option value="7">Huge</option>
                        </select>

                        <span style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></span>

                        <button class="fmt-btn" onclick="fmt('insertUnorderedList')">‚Ä¢ List</button>
                        <button class="fmt-btn" onclick="fmt('insertOrderedList')">1. List</button>
                        
                        <span style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></span>
                        
                        <button class="fmt-btn" onclick="insertColoredBox()" title="Info Box">üì¶ Box</button>
                        <button class="fmt-btn" onclick="insertVideo()" title="YouTube">‚ñ∂</button>
                        <button class="fmt-btn" onclick="createLink()" title="Link">üîó</button>
                        <button class="fmt-btn" onclick="cleanLaTeX()" title="Clean LaTeX">‚ú® Clean</button>
                    </div>

                    <div class="content-area" id="contentArea">
                        <div class="editor-container">
                            <input type="text" id="note-title" class="note-title-input" placeholder="Title" readonly>
                            <div id="editor" class="note-content" contenteditable="false"></div>
                        </div>
                    </div>
                        </div>
                </div>
            </main>
        </div>
    </div>

    <div id="universalModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modalTitle">Edit Item</div>
            
            <div id="modalForm"></div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modalSaveBtn">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDoc, query, orderBy, onSnapshot, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBd9E9VkE7bllIN13NYGz801F4Jue_VzVk",
            authDomain: "im-helper-d3a4a.firebaseapp.com",
            projectId: "im-helper-d3a4a",
            storageBucket: "im-helper-d3a4a.firebasestorage.app",
            messagingSenderId: "772636018512",
            appId: "1:772636018512:web:2b48ced86ea2f12a6f4e55",
            measurementId: "G-VBD2BRG0GH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const ADMIN_EMAIL = "qaireelroslan04@gmail.com"; 

        // STATE
        let isAdmin = false;
        let currentModuleId = null;
        let currentDiseaseId = null;
        let currentTabId = null; // NEW
        let modules = [];
        let diseases = [];
        let categories = []; // Unique list from diseases
        let isEditMode = false;
        let saveTimeout;

        const els = {
            homeView: document.getElementById('home-view'),
            appView: document.getElementById('app-view'),
            sidebar: document.getElementById('sidebar'),
            sidebarContent: document.getElementById('sidebarContent'),
            homeList: document.getElementById('homeList'),
            ctxMenu: document.getElementById('contextMenu'),
            modal: document.getElementById('universalModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalForm: document.getElementById('modalForm'),
            modalSaveBtn: document.getElementById('modalSaveBtn'),
            homeFab: document.getElementById('homeFab'),
            caseDetails: document.getElementById('caseDetails'),
            detailTitle: document.getElementById('detailTitle'),
            detailCat: document.getElementById('detailCat'),
            tabsContainer: document.getElementById('tabsContainer'),
            welcomeMsg: document.getElementById('welcomeMsg')
        };

        // --- AUTH ---
        window.handleAuth = () => {
            if (auth.currentUser) signOut(auth).then(()=>location.reload());
            else signInWithPopup(auth, provider);
        }

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                isAdmin = true;
                document.getElementById('adminBadge').style.display = 'block';
                els.homeFab.style.display = 'flex'; // Show Add button on home
            } else {
                isAdmin = false;
                document.getElementById('adminBadge').style.display = 'none';
                els.homeFab.style.display = 'none';
            }
            if(user) document.getElementById('userAvatar').src = user.photoURL;
            loadModules();
        });

        // --- HOME PAGE (MODULES) ---
        function loadModules() {
            onSnapshot(query(collection(db, "app_modules"), orderBy("order")), (snap) => {
                modules = [];
                els.homeList.innerHTML = "";
                snap.forEach(doc => {
                    const data = {id: doc.id, ...doc.data()};
                    modules.push(data);
                    
                    const el = document.createElement('div');
                    el.className = 'menu-item-home';
                    el.innerHTML = `
                        <div class="menu-text">
                            <div class="menu-label">${data.title}</div>
                            <div class="menu-sub">${data.subtitle || ''}</div>
                        </div>
                        <div style="font-size:1.5rem">${data.icon || 'üìÅ'}</div>
                    `;
                    
                    // Click to Open
                    el.onclick = () => openModule(data.id);
                    
                    // Right Click / Long Press
                    setupContextTrigger(el, 'module', data);
                    
                    els.homeList.appendChild(el);
                });
            });
        }

        // --- SIDEBAR (DISEASES) ---
        function openModule(id) {
            currentModuleId = id;
            els.homeView.style.display = 'none';
            els.appView.style.display = 'flex';
            
            // FIX: Auto-open sidebar AND update button position on mobile
            if(window.innerWidth <= 768) {
                toggleSidebar(true);
            }
            
            loadDiseases();
        }

        function loadDiseases() {
            const q = query(collection(db, "diseases"), where("moduleId", "==", currentModuleId));
            onSnapshot(q, (snap) => {
                diseases = [];
                snap.forEach(d => diseases.push({id: d.id, ...d.data()}));
                diseases.sort((a,b) => (a.order || 999) - (b.order || 999)); // Sort by order
                renderSidebar();
            });
        }

        function renderSidebar() {
            els.sidebarContent.innerHTML = "";
            categories = [...new Set(diseases.map(d => d.category))].sort();

            categories.forEach(cat => {
                const catContainer = document.createElement('div');
                catContainer.className = "category-group";
                catContainer.innerHTML = `<div class="category-header">${cat}</div>`;
                
                const listContainer = document.createElement('div');
                listContainer.className = "disease-list";
                // Add Sortable to this list
                // Inside renderSidebar...
                if(isAdmin) {
                    new Sortable(listContainer, {
                        group: 'diseases',
                        animation: 150,
                        delay: 700, // Wait 0.7s before drag starts
                        delayOnTouchOnly: true, // Only on touch
                        onStart: () => {
                            // If drag starts (after 0.7s), hide any popup that opened
                            els.ctxMenu.style.display = 'none';
                        },
                        onEnd: (evt) => handleReorder(evt, cat)
                    });
                }
                diseases.filter(d => d.category === cat).forEach(d => {
                    const item = document.createElement('div');
                    item.className = `disease-item ${currentDiseaseId === d.id ? 'active' : ''}`;
                    item.dataset.id = d.id; // REQUIRED FOR DRAG & DROP
                    item.innerText = d.name;
                    item.onclick = () => selectDisease(d);
                    setupContextTrigger(item, 'disease', d);
                    listContainer.appendChild(item);
                });

                catContainer.appendChild(listContainer);
                els.sidebarContent.appendChild(catContainer);
            });

            // Context Menu on Empty Sidebar Space (To Add Disease)
            els.sidebarContent.oncontextmenu = (e) => {
                if(e.target === els.sidebarContent && isAdmin) {
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY, [
                        { label: 'Add Disease', action: () => openModal('add_disease') }
                    ]);
                }
            };
        }

        // --- TAB LOGIC ---
        async function loadTabs(diseaseId) {
            const tabsRef = collection(db, "diseases", diseaseId, "tabs");
            const q = query(tabsRef, orderBy("order", "asc")); // Ensure you have an index or use simple sorting
            
            const snap = await onSnapshot(q, (snapshot) => {
                const tabs = [];
                snapshot.forEach(doc => tabs.push({id: doc.id, ...doc.data()}));
                
                // If no tabs exist, create default "Notes"
                if(tabs.length === 0) {
                    addTab("Notes", true); // Auto-create
                } else {
                    // Sort locally if needed
                    tabs.sort((a,b) => (a.order || 0) - (b.order || 0));
                    renderTabs(tabs);
                    
                    // If no tab selected, select first
                    if(!currentTabId || !tabs.find(t => t.id === currentTabId)) {
                        switchTab(tabs[0]);
                    }
                }
            });
        }

        function renderTabs(tabs) {
            const container = els.tabsContainer;
            container.innerHTML = "";
            
            tabs.forEach(tab => {
                const btn = document.createElement("div");
                btn.className = `tab-pill ${tab.id === currentTabId ? 'active' : ''}`;
                btn.innerText = tab.title;
                btn.onclick = () => switchTab(tab);
                
                // NEW: Right Click / Long Press to Edit Tab
                if(isAdmin) {
                    btn.oncontextmenu = (e) => {
                        e.preventDefault();
                        showContextMenu(e.clientX, e.clientY, [
                            { label: 'Rename Tab', action: () => renameTab(tab) },
                            { label: 'Delete Tab', class: 'delete', action: () => deleteTab(tab) }
                        ]);
                    };
                }
                
                container.appendChild(btn);
            });

            if(isAdmin) {
                const addBtn = document.createElement("div");
                addBtn.className = "add-tab-btn";
                addBtn.innerText = "+";
                addBtn.onclick = () => promptAddTab();
                container.appendChild(addBtn);
            }
        }

        // New Tab Actions
        async function renameTab(tab) {
            const newName = prompt("Rename Tab:", tab.title);
            if(newName) {
                await updateDoc(doc(db, "diseases", currentDiseaseId, "tabs", tab.id), { title: newName });
            }
        }

        async function deleteTab(tab) {
            if(confirm(`Delete tab "${tab.title}"?`)) {
                await deleteDoc(doc(db, "diseases", currentDiseaseId, "tabs", tab.id));
            }
        }
        async function promptAddTab() {
            const name = prompt("New Tab Name:");
            if(name) addTab(name);
        }

        async function addTab(title, isAuto = false) {
            if(!currentDiseaseId) return;
            const newOrder = Date.now(); // Simple ordering
            const docRef = await addDoc(collection(db, "diseases", currentDiseaseId, "tabs"), {
                title: title,
                content: "",
                order: newOrder
            });
            if(!isAuto) switchTab({id: docRef.id, title: title, content: ""});
        }

        async function switchTab(tab) {
            currentTabId = tab.id;
            
            // 1. Update UI
            const pills = document.querySelectorAll(".tab-pill");
            pills.forEach(p => p.classList.remove("active"));
            // Find the one we clicked (simple matching)
            for(let p of pills) { if(p.innerText === tab.title) p.classList.add("active"); }

            // 2. Load Content into Editor
            // We need to fetch the latest content in case it changed
            // But for responsiveness, we use the passed 'tab' object if available from snapshot
            // Ideally, we fetch the single doc to get 'content' specifically
            const docSnap = await getDoc(doc(db, "diseases", currentDiseaseId, "tabs", tab.id));
            
            const content = docSnap.exists() ? docSnap.data().content : "";
            
            document.getElementById('editor').innerHTML = content || '<p>Start writing...</p>';
            // Reset scroll
            document.getElementById('editor').scrollTop = 0;
        }

        // --- CORE UI ---
        window.goHome = () => {
            currentModuleId = null;
            els.appView.style.display = 'none';
            els.homeView.style.display = 'flex';
        };

        window.toggleRetract = () => {
            // Check if Mobile
            if (window.innerWidth <= 768) {
                toggleSidebar(); // Use mobile logic
            } else {
                // PC Logic
                els.sidebar.classList.toggle('collapsed');
                const btn = document.getElementById('sidebarToggle');
                if(btn) btn.classList.toggle('collapsed');
            }
        };

        window.toggleSidebar = (forceState) => {
            const isOpen = els.sidebar.style.transform === 'translateX(0px)';
            const shouldOpen = forceState !== undefined ? forceState : !isOpen;
            
            els.sidebar.style.transform = shouldOpen ? 'translateX(0px)' : '';
            document.getElementById('backdrop').style.display = shouldOpen ? 'block' : 'none';
            
            // FIX: Update button position for mobile
            const btn = document.getElementById('sidebarToggle');
            if(btn) {
                if(shouldOpen) btn.classList.add('mobile-open');
                else btn.classList.remove('mobile-open');
            }
        };

        function selectDisease(data) {
            currentDiseaseId = data.id;
            currentTabId = null; // Reset tab
            
            els.welcomeMsg.style.display = 'none';
            els.caseDetails.style.display = 'flex';
            
            // Set Header Info
            els.detailTitle.innerText = data.name;
            els.detailCat.innerText = data.category;
            document.getElementById('note-title').value = data.name; // Sync title input
            
            // Update Sidebar UI
            renderSidebar();
            
            // Load Tabs (This handles the content loading now)
            loadTabs(data.id);

            if(window.innerWidth <= 768) {
                toggleSidebar(false);
            }

            // --- NEW: Scroll Title Logic ---
            const mainTitle = document.querySelector('.app-title');
            const originalTitle = "IM Disease";
            
            // Reset title immediately
            mainTitle.innerText = originalTitle;

            // Remove old listener if exists to prevent duplicates (simple hack: clone node)
            const oldContent = document.getElementById('contentArea');
            const newContent = oldContent.cloneNode(false); // Clone without children
            // We must re-append children because cloneNode(false) is empty
            while(oldContent.firstChild) newContent.appendChild(oldContent.firstChild);
            oldContent.parentNode.replaceChild(newContent, oldContent);
            els.contentArea = newContent; // Update reference

            // Add new Listener
            els.contentArea.addEventListener('scroll', (e) => {
                if(e.target.scrollTop > 60) {
                    mainTitle.innerText = data.name; // Change header to Disease Name
                } else {
                    mainTitle.innerText = originalTitle; // Revert
                }
            });
        }

        // --- CONTEXT MENU SYSTEM ---
        function setupContextTrigger(el, type, data) {
            if (!isAdmin) return;

            // PC Right Click
            el.oncontextmenu = (e) => {
                e.preventDefault(); e.stopPropagation();
                showMenuForType(e.clientX, e.clientY, type, data);
            };

            // Mobile Long Press (0.2s)
            let timer;
            el.addEventListener('touchstart', (e) => {
                timer = setTimeout(() => {
                    // Open menu after 200ms
                    showMenuForType(e.touches[0].clientX, e.touches[0].clientY, type, data);
                }, 200); 
            });
            
            // Cancel if touch moves (scrolls) or ends
            el.addEventListener('touchmove', () => clearTimeout(timer));
            el.addEventListener('touchend', () => clearTimeout(timer));
        }

        function showMenuForType(x, y, type, data) {
            let items = [];
            if (type === 'module') {
                items = [
                    { label: 'Edit Section', action: () => openModal('edit_module', data) },
                    { label: 'Delete', class: 'delete', action: () => deleteItem('app_modules', data.id) }
                ];
            } else if (type === 'disease') {
                items = [
                    { label: 'Edit Disease', action: () => openModal('edit_disease', data) },
                    { label: 'Delete', class: 'delete', action: () => deleteItem('diseases', data.id) }
                ];
            }
            showContextMenu(x, y, items);
        }

        function showContextMenu(x, y, items) {
            els.ctxMenu.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = `ctx-item ${item.class || ''}`;
                div.innerText = item.label;
                div.onclick = () => {
                    els.ctxMenu.style.display = 'none';
                    item.action();
                };
                els.ctxMenu.appendChild(div);
            });
            
            // Positioning bounds check
            els.ctxMenu.style.display = 'block';
            const w = els.ctxMenu.offsetWidth;
            const h = els.ctxMenu.offsetHeight;
            
            // Adjust if off screen
            if (x + w > window.innerWidth) x -= w;
            if (y + h > window.innerHeight) y -= h;

            els.ctxMenu.style.left = `${x}px`;
            els.ctxMenu.style.top = `${y}px`;
        }

        document.addEventListener('click', () => els.ctxMenu.style.display = 'none');

        // --- UNIVERSAL MODAL & FORMS ---
        window.openModal = (type, data = {}) => {
            els.modal.style.display = 'flex';
            let html = '';
            let onSave = null;

            if (type === 'add_module' || type === 'edit_module') {
                els.modalTitle.innerText = type === 'add_module' ? 'New Section' : 'Edit Section';
                html = `
                    <div class="form-group"><label class="form-label">Title</label><input id="inpTitle" class="form-input" value="${data.title || ''}"></div>
                    <div class="form-group"><label class="form-label">Subtitle</label><input id="inpSub" class="form-input" value="${data.subtitle || ''}"></div>
                    <div class="form-group"><label class="form-label">Icon (Emoji)</label><input id="inpIcon" class="form-input" value="${data.icon || ''}"></div>
                `;
                onSave = async () => {
                    const payload = {
                        title: document.getElementById('inpTitle').value,
                        subtitle: document.getElementById('inpSub').value,
                        icon: document.getElementById('inpIcon').value,
                        order: data.order || Date.now()
                    };
                    if(type === 'add_module') await addDoc(collection(db, "app_modules"), payload);
                    else await updateDoc(doc(db, "app_modules", data.id), payload);
                };
            } 
            else if (type === 'add_disease' || type === 'edit_disease') {
                els.modalTitle.innerText = type === 'add_disease' ? 'New Disease' : 'Edit Disease';
                // Category Datalist
                const catOptions = categories.map(c => `<option value="${c}">`).join('');
                html = `
                    <div class="form-group"><label class="form-label">Disease Name</label><input id="inpName" class="form-input" value="${data.name || ''}"></div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input id="inpCat" class="form-input" list="catList" value="${data.category || ''}">
                        <datalist id="catList">${catOptions}</datalist>
                    </div>
                `;
                onSave = async () => {
                    const payload = {
                        name: document.getElementById('inpName').value,
                        category: document.getElementById('inpCat').value,
                        moduleId: currentModuleId
                    };
                    if(type === 'add_disease') await addDoc(collection(db, "diseases"), payload);
                    else await updateDoc(doc(db, "diseases", data.id), payload);
                };
            }

            els.modalForm.innerHTML = html;
            els.modalSaveBtn.onclick = async () => {
                await onSave();
                window.closeModal();
            };
        };

        window.closeModal = () => els.modal.style.display = 'none';

        // --- LOGIC: DELETE & REORDER ---
        async function handleReorder(evt, targetCategory) {
            // 1. Get the new category from the DOM header where item was dropped
            // The item is dropped into a listContainer, its parent is catContainer
            const newCategory = evt.to.parentElement.querySelector('.category-header').innerText;
            
            const batch = writeBatch(db);
            const listItems = evt.to.querySelectorAll('.disease-item');
            
            // 2. Batch update ALL items in this list to save the order
            listItems.forEach((el, index) => {
                const id = el.dataset.id;
                batch.update(doc(db, "diseases", id), {
                    category: newCategory,
                    order: index + 1 // Save numerical order
                });
            });

            await batch.commit();
        }

        // FAB Listeners
        els.homeFab.onclick = () => openModal('add_module');

        // --- EDITOR LOGIC ---
        
        // Toggle Edit Mode (Call this from your existing Edit/Context menu)
        window.toggleEditMode = (forceState) => {
            isEditMode = forceState !== undefined ? forceState : !isEditMode;
            const editor = document.getElementById('editor');
            const toolbar = document.getElementById('editor-toolbar');
            const titleInput = document.getElementById('note-title');
            
            if(isEditMode) {
                editor.contentEditable = true;
                titleInput.removeAttribute('readonly');
                toolbar.classList.add('visible');
            } else {
                editor.contentEditable = false;
                titleInput.setAttribute('readonly', true);
                toolbar.classList.remove('visible');
                // Trigger save on exit
                if(currentDiseaseId) saveNoteContent(currentDiseaseId);
            }
        };

        // Basic Formatting
        window.fmt = (cmd, val) => {
            document.execCommand(cmd, false, val);
            document.getElementById('editor').focus();
        };

        // Insert Table (Fixed Logic)
        window.insertTable = () => {
            const html = `
                <table style="width:100%; border-collapse: collapse; margin: 10px 0; border: 1px solid var(--border-color);">
                    <tr><td style="border: 1px solid var(--border-color); padding: 8px;">Header 1</td><td style="border: 1px solid var(--border-color); padding: 8px;">Header 2</td></tr>
                    <tr><td style="border: 1px solid var(--border-color); padding: 8px;">Cell 1</td><td style="border: 1px solid var(--border-color); padding: 8px;">Cell 2</td></tr>
                </table><p><br></p>`;
            fmt('insertHTML', html);
        };

        // Auto-Save Logic
        document.getElementById('editor').addEventListener('input', () => {
             if(currentDiseaseId) {
                 clearTimeout(saveTimeout);
                 saveTimeout = setTimeout(() => saveNoteContent(currentDiseaseId), 1000);
             }
        });

        // Save to Firebase
        async function saveNoteContent(diseaseId) {
            if(!currentTabId) return;
            
            const content = document.getElementById('editor').innerHTML;
            
            // 1. Save to the TAB
            await updateDoc(doc(db, "diseases", diseaseId, "tabs", currentTabId), { 
                content: content,
                lastUpdated: new Date()
            });

            // 2. NEW: Update Main Disease Document with searchable text
            // We create a 'searchContent' field that combines current content
            // NOTE: Ideally you'd aggregate all tabs, but for now we index the *active* tab text
            const div = document.createElement("div");
            div.innerHTML = content;
            const plainText = div.innerText; // Strip HTML

            await updateDoc(doc(db, "diseases", diseaseId), {
                // We append to a specific field or just update a 'lastEditedContent' field
                // Simple approach: Update a 'keywords' or 'searchSnippet' field
                searchSnippet: plainText.substring(0, 500) // Index first 500 chars
            });
        }
        // --- SEARCH LOGIC (From IM Notes Pro) ---
        document.getElementById('searchSidebar').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const container = document.getElementById('sidebarContent');
            
            if(query.length < 2) { renderSidebar(); return; }

            // Filter based on Name OR SearchSnippet
            const results = diseases.filter(d => {
                const nameMatch = d.name.toLowerCase().includes(query);
                const contentMatch = (d.searchSnippet || "").toLowerCase().includes(query);
                return nameMatch || contentMatch;
            });

            container.innerHTML = "";
            results.forEach(d => {
                const div = document.createElement("div");
                div.className = "search-result-item";
                
                // Highlight Logic
                const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                const titleHtml = d.name.replace(regex, "<mark>$1</mark>");
                
                div.innerHTML = `
                    <div class="result-path">${d.category}</div>
                    <div class="result-title">${titleHtml}</div>
                `;
                div.onclick = () => selectDisease(d);
                container.appendChild(div);
            });
        });

        // --- EDITOR ENHANCEMENTS ---

        // 1. Hotkeys & Shortcuts
        document.getElementById('editor').addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                const key = e.key.toLowerCase();
                if(key === 'b') { e.preventDefault(); fmt('bold'); }
                if(key === 'i') { e.preventDefault(); fmt('italic'); }
                if(key === 'u') { e.preventDefault(); fmt('underline'); }
            }
        });

        // 2. Insert YouTube Video
        window.insertVideo = () => {
            const url = prompt("Paste YouTube URL:");
            if(url) {
                const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/);
                if(match && match[1]) {
                    const html = `<div style="position:relative; padding-bottom:56.25%; height:0; margin:1rem 0; overflow:hidden; border-radius:8px;"><iframe src="https://www.youtube.com/embed/${match[1]}" style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" allowfullscreen></iframe></div><p><br></p>`;
                    fmt('insertHTML', html);
                } else { alert("Invalid YouTube URL"); }
            }
        };

        // 3. Insert Colored Box
        window.insertColoredBox = () => {
            const color = prompt("Box Color (blue, red, green, orange):", "blue");
            const title = prompt("Box Title:", "Clinical Pearl");
            
            const colorMap = {
                blue:   { bg: "rgba(59, 130, 246, 0.1)", border: "#3b82f6" },
                red:    { bg: "rgba(239, 68, 68, 0.1)", border: "#ef4444" },
                green:  { bg: "rgba(34, 197, 94, 0.1)", border: "#22c55e" },
                orange: { bg: "rgba(249, 115, 22, 0.1)", border: "#f97316" }
            };
            
            const theme = colorMap[color.toLowerCase()] || colorMap['blue'];
            
            const html = `
                <div class="info-box" style="background-color:${theme.bg}; border-left-color:${theme.border};">
                    <div class="box-header" style="background-color:${theme.bg}; color:${theme.border}">${title}</div>
                    <div class="box-content">Write content here...</div>
                </div><p><br></p>
            `;
            fmt('insertHTML', html);
        };

        // 4. Create Link (Fixed)
        window.createLink = () => {
            const url = prompt("Enter URL:");
            if(url) fmt('createLink', url);
        };

        // 5. Clean LaTeX (From Notes Pro)
        window.cleanLaTeX = () => {
            const editor = document.getElementById('editor');
            let html = editor.innerHTML;
            
            html = html
                .replace(/\\ge/g, '‚â•').replace(/\\le/g, '‚â§')
                .replace(/\\approx/g, '‚âà').replace(/\\pm/g, '¬±')
                .replace(/\\ne/g, '‚â†').replace(/\\times/g, '√ó')
                .replace(/\\rightarrow/g, '‚Üí').replace(/\\leftarrow/g, '‚Üê')
                .replace(/\^\\circ/g, '¬∞');
            
            // Remove \text{} wrappers
            html = html.replace(/\\text\{([^}]+)\}/g, '$1');
            
            editor.innerHTML = html;
            // Trigger save
            if(currentTabId && currentDiseaseId) saveNoteContent(currentDiseaseId);
        };

    </script>
</body>
</html>
