<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IM Disease</title>

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- 1. DESIGN SYSTEM --- */
        :root {
            --bg-body: #000000; --bg-sidebar: #050505; --bg-card: #0a0a0a; --bg-box: #111111; --bg-input: #171717;
            --border-color: #27272a; --text-main: #e2e8f0; --text-muted: #94a3b8;
            --accent-color: #3b82f6; --accent-bg: #172554; --accent-text: #bfdbfe;
            --header-bg: rgba(0, 0, 0, 0.95);
            --sidebar-width: 300px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */

        /* Sticky Header Transitions */
        body.scrolled header {
            border-bottom: 1px solid var(--border-color); /* Fix E: Added Line */
        }
        
        /* Hide original app title/version when scrolled */
        body.scrolled .app-title, 
        body.scrolled .version-badge {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        /* The Disease Name (Hidden by default in header, visible when scrolled) */
        #headerDiseaseTitle {
            position: absolute; left: 60px; 
            /* Fix B: Constraint width so it doesn't hit Admin/Profile buttons */
            right: 120px; 
            height: 100%; display: flex; flex-direction: column; justify-content: center;
            opacity: 0; transform: translateY(20px); transition: all 0.3s ease;
            pointer-events: none;
        }
        body.scrolled #headerDiseaseTitle {
            opacity: 1; transform: translateY(0);
            pointer-events: auto;
        }
        
        #headerDName { 
            font-size: 1rem; font-weight: 800; color: white;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; /* Fix B: Ellipsis */
        }
        #headerDiseaseCat {
            font-size: 0.65rem; color: var(--accent-color); 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin: 0; padding: 0; border: none; /* Cleaner look */
        }

        /* Move the Detail Header Up and Away */
        .details-header {
            transition: all 0.3s ease;
            opacity: 1; transform: translateY(0);
            margin-bottom: 0;
        }
        body.scrolled .details-header {
            /* Fix E: Reduce gap (pull it up higher) */
            margin-top: -95px; 
            opacity: 0;
            pointer-events: none;
        }
        
        /* Move Edit Button Down to Tabs level */
        .edit-btn-mobile-move {
            position: fixed; top: 75px; right: 20px; z-index: 60;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            #headerDiseaseTitle { right: 70px; /* More space on mobile */ }
        }
        
        /* Move Edit Button Down to Tabs level */
        .edit-btn-mobile-move {
            position: fixed; top: 75px; right: 20px; z-index: 60;
            transition: all 0.3s ease;
        }
        
        header { background-color: var(--header-bg); padding: 0 1rem; height: 60px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); z-index: 70; flex-shrink: 0; transition: all 0.3s ease; }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { font-size: 1.2rem; cursor: pointer; }
        .app-title { font-size: 1.1rem; font-weight: 800; color: var(--accent-color); white-space: nowrap; cursor: pointer; transition: color 0.3s; }
        .version-badge {
            font-size: 0.65rem; color: var(--text-muted); margin-left: 8px; padding: 2px 6px;
            border: 1px solid var(--border-color); border-radius: 12px; opacity: 0.7; letter-spacing: 0.5px;
        }
        
        /* Admin Badge */
        .admin-badge { 
            background: var(--accent-color); color: white; padding: 2px 6px; border-radius: 4px; 
            font-size: 0.6rem; font-weight: 800; letter-spacing: 1px; display: none; margin-right: 10px;
        }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border-color); cursor: pointer; }
        
        /* --- LAYOUT --- */
        #app-container { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* --- HOME VIEW --- */
        #home-view { 
            position: absolute; inset: 0; z-index: 60; background: var(--bg-body);
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            gap: 2rem; padding: 2rem; overflow-y: auto; 
        }
        .menu-list { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 400px; }
        .menu-item-home { 
            display: flex; align-items: center; justify-content: space-between; padding: 1.2rem 1.5rem; 
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.75rem; 
            cursor: pointer; transition: transform 0.1s;
        }
        .menu-item-home:active { transform: scale(0.98); }
        .menu-text { display: flex; flex-direction: column; }
        .menu-label { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .menu-sub { font-size: 0.8rem; color: var(--text-muted); }

        /* --- SIDEBAR --- */
        aside { 
            width: var(--sidebar-width); background: var(--bg-sidebar); 
            border-right: 1px solid var(--border-color); display: flex; flex-direction: column; 
            transition: width 0.3s ease, transform 0.3s ease; 
            z-index: 100; /* CRITICAL FIX: Sits above Header (70) */
            position: relative; overflow: hidden; white-space: nowrap;
        }
        aside.collapsed { width: 0; border: none; }
        
        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .search-input { width: 100%; padding: 0.6rem; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); border-radius: 0.5rem; outline: none; }
        .sidebar-content { flex: 1; overflow-y: auto; padding-bottom: 2rem; }
        
        .category-group { margin-bottom: 10px; }
        .category-header { 
            font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; 
            padding: 10px 15px; letter-spacing: 1px; user-select: none;
        }
        .disease-item {
            padding: 10px 15px; cursor: pointer; border-left: 3px solid transparent; 
            font-size: 0.9rem; color: var(--text-main); transition: background 0.2s;
        }
        .disease-item:hover { background: var(--bg-input); }
        .disease-item.active { background: var(--bg-input); border-left-color: var(--accent-color); font-weight: 600; }
        .sortable-ghost { opacity: 0.4; background: var(--bg-input); }

        /* --- MAIN CONTENT --- */
        main { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); overflow: hidden; position: relative; }
        .welcome-msg { margin: auto; text-align: center; color: var(--text-muted); }
        #caseDetails { display: none; flex-direction: column; height: 100%; }
        
        .details-header { 
            padding: 1.5rem 2rem; border-bottom: 1px solid var(--border-color); 
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .cat-badge { font-size: 0.7rem; color: var(--accent-color); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .main-title { font-size: 1.8rem; font-weight: 800; margin-top: 5px; color: white; }

        /* Tabs */
        .tabs-container { 
            padding: 10px 2rem; border-bottom: 1px solid var(--border-color); 
            display: flex; gap: 10px; overflow-x: auto; background: var(--bg-body);
            touch-action: pan-x; /* Fixes mobile scrolling */
        }
        .tab-pill {
            padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            background: var(--bg-input); color: var(--text-muted); cursor: pointer; border: 1px solid transparent;
            white-space: nowrap; transition: all 0.2s;
        }
        .tab-pill:hover { background: var(--bg-box); color: var(--text-main); }
        .tab-pill.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .add-tab-btn {
            width: 30px; height: 30px; border-radius: 50%; border: 1px dashed var(--text-muted);
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; color: var(--text-muted);
        }

        /* --- ALPHA 0.1.7+: PRO EDITOR --- */
        #note-title { display: none; } 

        .content-area { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        .editor-container { max-width: 1000px; margin: 0 auto; width: 100%; padding: 2rem 5%; flex: 1; display: flex; flex-direction: column; }
        
        /* Toolbar */
        .editor-toolbar {
            display: none; align-items: center; gap: 4px; padding: 8px 16px;
            background: var(--bg-card); border-bottom: 1px solid var(--border-color);
            overflow-x: auto; white-space: nowrap; position: sticky; top: 0; z-index: 30;
        }
        .editor-toolbar.visible { display: flex; }
        
        .fmt-btn {
            background: transparent; border: 1px solid transparent; color: var(--text-muted);
            cursor: pointer; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.85rem;
        }
        .fmt-btn:hover { background: var(--bg-input); color: var(--text-main); }
        .fmt-btn.active { background-color: rgba(59, 130, 246, 0.2); color: var(--accent-color); border-color: var(--accent-color); }

        .font-size-input {
            width: 50px; background: var(--bg-input); border: 1px solid var(--border-color);
            color: white; border-radius: 4px; text-align: center; font-size: 0.8rem; padding: 2px;
        }

        /* Edit Toggle Active State */
        .icon-btn.active {
            color: var(--accent-color) !important;
            filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.5)); transform: scale(1.1);
        }

        .note-content { font-size: 1rem; line-height: 1.6; color: var(--text-main); min-height: 60vh; outline: none; }
        
        .placeholder-text { padding: 40px; text-align: center; color: var(--text-muted); font-style: italic; pointer-events: none; }

        /* Clinical Boxes */
        .clinical-box {
            border-radius: 12px; margin-bottom: 20px; background: var(--bg-card);
            border: 2px solid transparent; overflow: hidden; transition: all 0.2s ease;
            position: relative;
        }
        .clinical-box:focus-within { box-shadow: 0 0 15px rgba(0,0,0,0.5); transform: translateY(-2px); }
        
        .box-green  { border-color: #10b981; } .box-green .box-header { background: #064e3b; color: #10b981; }
        .box-blue   { border-color: #3b82f6; } .box-blue .box-header { background: #1e3a8a; color: #60a5fa; }
        .box-red    { border-color: #ef4444; } .box-red .box-header { background: #7f1d1d; color: #fca5a5; }
        .box-orange { border-color: #f59e0b; } .box-orange .box-header { background: #78350f; color: #fcd34d; }

        .box-header { 
            padding: 10px 15px; font-size: 0.85rem; font-weight: 800; 
            text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .box-delete-btn {
            background: none; border: none; 
            color: rgba(255,255,255,0.7); cursor: pointer;
            font-size: 1.5rem; line-height: 1; padding: 0 8px;
            display: none; /* Hidden by default, shown in Edit Mode */
            transition: color 0.2s;
        }
        .box-delete-btn:hover { color: #ef4444; }

        /* CRITICAL FIX: Enable selection for the box AND ALL its content */
        .box-body, .box-body *, .box-header-title { 
            user-select: text !important; 
            -webkit-user-select: text !important;
            cursor: text;
        }

        .box-body { 
            padding: 15px; color: var(--text-main); font-size: 1rem; line-height: 1.6; 
            outline: none; min-height: 50px; 
            white-space: pre-wrap; /* Preserves spaces but wraps text */
            word-break: break-word;
        }
        
        /* Allow rich text elements inside box body */
        .box-body p { margin-bottom: 10px; }
        .box-body ul, .box-body ol { padding-left: 25px; margin-bottom: 10px; }
        .box-body blockquote { border-left: 3px solid var(--accent-color); padding-left: 10px; opacity: 0.8; }

        /* FAB for Boxes */
        .editor-fab-container {
            position: fixed; bottom: 30px; right: 30px;
            display: none; flex-direction: column-reverse; align-items: center; gap: 10px; z-index: 100;
        }
        .editor-fab-container.visible { display: flex; }
        .fab-main {
            width: 56px; height: 56px; border-radius: 50%; background: var(--accent-color); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.2s;
        }
        .fab-main:active { transform: scale(0.9); }
        .fab-opt {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; opacity: 0; transform: translateY(20px);
            transition: all 0.2s; pointer-events: none;
        }
        .editor-fab-container:hover .fab-opt { opacity: 1; transform: translateY(0); pointer-events: auto; }

        /* Search Results */
        .search-result-item { padding: 10px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .search-result-item:hover { background: var(--bg-input); }
        .result-title { font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        mark { background: rgba(59, 130, 246, 0.3); color: white; padding: 0 2px; border-radius: 2px; }

        /* --- CONTEXT MENU & MODALS --- */
        #contextMenu {
            position: fixed; display: none; background: var(--bg-card); 
            border: 1px solid var(--border-color); border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 9999; min-width: 150px; padding: 5px;
        }
        .ctx-item { padding: 8px 12px; cursor: pointer; font-size: 0.9rem; color: var(--text-main); border-radius: 4px; }
        .ctx-item:hover { background: var(--accent-color); color: white; }
        .ctx-item.delete:hover { background: #dc2626; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: var(--bg-card); border: 1px solid var(--border-color); width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: var(--text-main); }
        .form-input { width: 100%; padding: 10px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 6px; color: white; outline: none; margin-bottom: 10px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-cancel { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }

        /* FAB Home */
        .fab-home {
            position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px;
            background: var(--accent-color); border-radius: 50%; color: white;
            display: none; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; z-index: 80;
        }

        /* Toggle Button */
        .sidebar-toggle { 
            display: flex; position: fixed; left: 300px; bottom: 80px; width: 32px; height: 42px;
            border-radius: 0 8px 8px 0; border: 1px solid var(--border-color); border-left: none; 
            background: var(--bg-card); box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            align-items: center; justify-content: center; transition: left 0.3s ease; z-index: 45;
            cursor: pointer;
        }
        /* PC Closed: Sit on left edge, arrow points right */
        .sidebar-toggle.collapsed { left: 0; }
        .sidebar-toggle.collapsed div { transform: rotate(180deg); }

        /* FAB Options (Click to open, not hover) */
        .editor-fab-container {
            position: fixed; bottom: 30px; right: 30px;
            display: none; flex-direction: column-reverse; align-items: center; gap: 10px; z-index: 100;
        }
        .editor-fab-container.visible { display: flex; }
        
        .fab-main {
            width: 56px; height: 56px; border-radius: 50%; background: var(--accent-color); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.2s;
        }
        .fab-main:active { transform: scale(0.9); }
        
        .fab-opt {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; opacity: 0; transform: translateY(20px);
            transition: all 0.2s; pointer-events: none;
        }
        
        /* Show options only when active class is added by JS */
        .editor-fab-container.active .fab-opt { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        /* Image Resizing (Google Docs Style) */
        .img-wrapper {
            display: inline-block; position: relative; margin: 10px 0;
            max-width: 100%; border: 2px solid transparent; transition: border 0.2s;
        }
        .img-wrapper:hover { border-color: rgba(59, 130, 246, 0.5); }
        .img-wrapper.selected { border-color: var(--accent-color); }
        
        .img-resizer {
            width: 12px; height: 12px; background: var(--accent-color); border: 2px solid white;
            position: absolute; bottom: -6px; right: -6px; cursor: nwse-resize; border-radius: 50%;
            display: none; z-index: 10;
        }
        .img-wrapper.selected .img-resizer { display: block; }
        .img-wrapper img { display: block; max-width: 100%; pointer-events: none; /* Prevents native drag */ }

        @media (max-width: 768px) {
            aside { position: absolute; height: 100%; transform: translateX(-100%); width: 80%; }
            aside.open { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            /* Mobile Toggle: Fixed to left edge */
            .sidebar-toggle { left: -1px !important; transform: none; border-radius: 0 8px 8px 0; border-left: none; border-right: 1px solid var(--border-color); }
            /* When open, push to 80% */
            .sidebar-toggle.mobile-open { left: 80% !important; border-radius: 8px 0 0 8px; border-right: none; border-left: 1px solid var(--border-color); margin-left: -1px; }
            .sidebar-toggle div { transition: transform 0.3s; }
            .sidebar-toggle.mobile-open div { transform: rotate(180deg); }
            .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 35; }
            .backdrop.open { display: block; }
        }
    </style>
</head>
<body oncontextmenu="return false;"> <div id="contextMenu"></div>

    <header>
        <div class="header-left">
            <div class="logo-icon" onclick="goHome()">‚öïÔ∏è</div>
            <span class="app-title" onclick="goHome()">IM Disease</span>
            <div id="headerDiseaseTitle">
                <span id="headerDName"></span>
                <span id="headerDiseaseCat"></span>
            </div>
            <span class="version-badge">Alpha 0.2.10</span>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div id="adminBadge" class="admin-badge">ADMIN</div>
            
            <div style="position:relative;">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&background=171717&color=fff" class="user-avatar" onclick="toggleProfileMenu()">
                
                <div id="profileMenu" style="display:none; position:absolute; right:0; top:40px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; width:160px; box-shadow:0 4px 15px rgba(0,0,0,0.5); z-index:100; overflow:hidden;">
                    <div onclick="exportData()" class="ctx-item">Backup Data (JSON)</div>
                    <div onclick="triggerImport()" class="ctx-item">Import Data</div>
                    <div onclick="restoreAutoBackup()" class="ctx-item" style="color:#3b82f6;">‚Ü∫ Restore Auto-Save</div>
                    <div style="height:1px; background:var(--border-color); margin:4px 0;"></div>
                    <div onclick="handleAuth()" class="ctx-item" style="color:#ef4444;">Log Out</div>
                </div>
            </div>
            
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
            <input type="file" id="importNotebookFile" accept=".json" style="display:none" onchange="handleNotebookImport(this)">
        </div>
    </header>

    <div id="app-container">
        
        <div id="home-view">
            <h2>Select Section</h2>
            <div id="homeList" class="menu-list"></div>
            <div id="homeFab" class="fab-home">+</div>
        </div>

        <div id="app-view" style="display:none; width:100%; height:100%;">
            <div class="backdrop" id="backdrop" onclick="toggleSidebar()"></div>
            
            <aside id="sidebar">
                <div class="sidebar-header">
                    <input type="text" id="searchSidebar" class="search-input" placeholder="Search...">
                </div>
                <div id="sidebarContent" class="sidebar-content"></div>
            </aside>
            <div class="sidebar-toggle" id="sidebarToggle" onclick="toggleRetract()"><div>‚ùÆ</div></div>

            <main>
                <div id="welcomeMsg" class="welcome-msg">Select a disease from the sidebar</div>
                
                <div id="caseDetails">
                    <div class="details-header">
                        <div>
                            <div id="detailCat" class="cat-badge">CATEGORY</div>
                            <div id="detailTitle" class="main-title">Disease Name</div>
                        </div>
                        <button id="editToggleBtn" class="icon-btn" style="background:none;border:none;color:var(--text-muted);cursor:pointer;" onclick="toggleEditMode()" title="Edit Note">
                            <svg style="width:20px;height:20px;fill:currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        </button>
                    </div>
                    
                    <div class="tabs-container" id="tabsContainer"></div>

                    <div id="editor-toolbar" class="editor-toolbar">
                        <button class="fmt-btn" onclick="fmt('undo')" title="Undo">‚Ü©</button>
                        <button class="fmt-btn" onclick="fmt('redo')" title="Redo">‚Ü™</button>
                        <span style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></span>
                        
                        <input type="number" id="fontSizeInp" class="font-size-input" value="3" min="1" max="7" onchange="fmt('fontSize', this.value)" title="Font Size (1-7)">
                        
                        <span style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></span>
                        
                        <button class="fmt-btn" id="btnBold" onclick="fmt('bold')" title="Bold (Ctrl+B)"><b>B</b></button>
                        <button class="fmt-btn" id="btnItalic" onclick="fmt('italic')" title="Italic (Ctrl+I)"><i>I</i></button>
                        <button class="fmt-btn" id="btnUnderline" onclick="fmt('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
                        <button class="fmt-btn" id="btnStrike" onclick="fmt('strikeThrough')" title="Strikethrough"><s>S</s></button>
                        
                        <span style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></span>
                        
                        <button class="fmt-btn" id="btnAlignLeft" onclick="fmt('justifyLeft')" title="Left">‚á§</button>
                        <button class="fmt-btn" id="btnAlignCenter" onclick="fmt('justifyCenter')" title="Center">‚áπ</button>
                        <button class="fmt-btn" id="btnAlignRight" onclick="fmt('justifyRight')" title="Right">‚á•</button>

                        <span style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></span>

                        <button class="fmt-btn" id="btnUL" onclick="fmt('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                        <button class="fmt-btn" id="btnOL" onclick="fmt('insertOrderedList')" title="Numbered List">1. List</button>
                        
                        <span style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></span>

                        <button class="fmt-btn" onclick="triggerImage()" title="Insert Image">üñºÔ∏è</button>
                        <input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
                        
                        <span style="width:1px; background:var(--border-color); height:16px; margin:0 5px;"></span>
                        
                        <button class="fmt-btn" onclick="insertVideo()" title="YouTube">‚ñ∂</button>
                        <button class="fmt-btn" onclick="cleanLaTeX()" title="Clean LaTeX">‚ú®</button>
                    </div>

                    <div class="content-area" id="contentArea">
                        <div class="editor-container">
                            <input type="text" id="note-title" class="note-title-input" placeholder="Title" readonly>
                            <div id="editor" class="note-content" contenteditable="false"></div>
                        </div>
                    </div>

                    <div id="editorFab" class="editor-fab-container">
                        <div class="fab-main">+</div>
                        <div class="fab-opt" style="background:#10b981;" onclick="insertBox('green')"></div>
                        <div class="fab-opt" style="background:#3b82f6;" onclick="insertBox('blue')"></div>
                        <div class="fab-opt" style="background:#ef4444;" onclick="insertBox('red')"></div>
                        <div class="fab-opt" style="background:#f59e0b;" onclick="insertBox('orange')"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="universalModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modalTitle">Edit Item</div>
            <div id="modalForm"></div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modalSaveBtn">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDoc, getDocs, setDoc, query, orderBy, onSnapshot, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBd9E9VkE7bllIN13NYGz801F4Jue_VzVk",
            authDomain: "im-helper-d3a4a.firebaseapp.com",
            projectId: "im-helper-d3a4a",
            storageBucket: "im-helper-d3a4a.firebasestorage.app",
            messagingSenderId: "772636018512",
            appId: "1:772636018512:web:2b48ced86ea2f12a6f4e55",
            measurementId: "G-VBD2BRG0GH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const ADMIN_EMAIL = "qaireelroslan04@gmail.com"; 

        // STATE
        let isAdmin = false;
        let currentModuleId = null;
        let currentDiseaseId = null;
        let currentTabId = null;
        let pendingTabId = null; // Fix for race condition
        let modules = [];
        let diseases = [];
        let categories = []; 
        let isEditMode = false;
        let saveTimeout;
        let isCreatingTab = false;
        
        // ADD THIS LINE BELOW:
        let tabsUnsubscribe = null;

        const els = {
            homeView: document.getElementById('home-view'),
            appView: document.getElementById('app-view'),
            sidebar: document.getElementById('sidebar'),
            sidebarContent: document.getElementById('sidebarContent'),
            homeList: document.getElementById('homeList'),
            ctxMenu: document.getElementById('contextMenu'),
            modal: document.getElementById('universalModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalForm: document.getElementById('modalForm'),
            modalSaveBtn: document.getElementById('modalSaveBtn'),
            homeFab: document.querySelector('.fab-home'),
            caseDetails: document.getElementById('caseDetails'),
            detailTitle: document.getElementById('detailTitle'),
            detailCat: document.getElementById('detailCat'),
            tabsContainer: document.getElementById('tabsContainer'),
            welcomeMsg: document.getElementById('welcomeMsg'),
            contentArea: document.getElementById('contentArea')
        };

        // --- AUTH ---
        window.handleAuth = () => {
            if (auth.currentUser) signOut(auth).then(()=>location.reload());
            else signInWithPopup(auth, provider);
        }

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                isAdmin = true;
                startAutoBackup();
                if(document.getElementById('adminBadge')) document.getElementById('adminBadge').style.display = 'block';
                if(els.homeFab) els.homeFab.style.display = 'flex'; 
            } else {
                isAdmin = false;
                if(document.getElementById('adminBadge')) document.getElementById('adminBadge').style.display = 'none';
                if(els.homeFab) els.homeFab.style.display = 'none';
            }
            if(user && document.getElementById('userAvatar')) document.getElementById('userAvatar').src = user.photoURL;
            loadModules();
        });

        // --- HOME PAGE ---
        function loadModules() {
            onSnapshot(query(collection(db, "app_modules"), orderBy("order")), (snap) => {
                modules = [];
                els.homeList.innerHTML = "";
                snap.forEach(doc => {
                    const data = {id: doc.id, ...doc.data()};
                    modules.push(data);
                    
                    const el = document.createElement('div');
                    el.className = 'menu-item-home';
                    el.innerHTML = `
                        <div class="menu-text">
                            <div class="menu-label">${data.title}</div>
                            <div class="menu-sub">${data.subtitle || ''}</div>
                        </div>
                        <div style="font-size:1.5rem">${data.icon || 'üìÅ'}</div>
                    `;
                    el.onclick = () => openModule(data.id);
                    setupContextTrigger(el, 'module', data);
                    els.homeList.appendChild(el);
                });
            });
        }

        // --- SIDEBAR ---
        function openModule(id) {
            currentModuleId = id;
            els.homeView.style.display = 'none';
            els.appView.style.display = 'flex';
            
            // Fix C & D: Ensure clean slate when changing modules
            els.caseDetails.style.display = 'none';
            els.welcomeMsg.style.display = 'block';
            
            if(window.innerWidth <= 768) toggleSidebar(true);
            els.sidebarContent.innerHTML = '<div style="padding:20px;text-align:center;color:#666">Loading...</div>';
            loadDiseases();
        }

        function loadDiseases() {
            const q = query(collection(db, "diseases"), where("moduleId", "==", currentModuleId));
            onSnapshot(q, (snap) => {
                diseases = [];
                snap.forEach(d => diseases.push({id: d.id, ...d.data()}));
                diseases.sort((a,b) => (a.order || 999) - (b.order || 999));
                renderSidebar();
            });
        }

        function renderSidebar() {
            els.sidebarContent.innerHTML = "";
            categories = [...new Set(diseases.map(d => d.category))].sort();

            categories.forEach(cat => {
                const catContainer = document.createElement('div');
                catContainer.className = "category-group";
                catContainer.innerHTML = `<div class="category-header">${cat}</div>`;
                
                const listContainer = document.createElement('div');
                listContainer.className = "disease-list";
                if(isAdmin) {
                    // FIX: Variable must be 'listContainer', not 'sortList'
                    new Sortable(listContainer, {
                        group: 'diseases', 
                        animation: 150,
                        delay: 200,
                        delayOnTouchOnly: true,
                        onStart: () => { els.ctxMenu.style.display = 'none'; },
                        onEnd: (evt) => handleReorder(evt)
                    });
                }
                diseases.filter(d => d.category === cat).forEach(d => {
                    const item = document.createElement('div');
                    item.className = `disease-item ${currentDiseaseId === d.id ? 'active' : ''}`;
                    item.dataset.id = d.id; 
                    item.innerText = d.name;
                    item.onclick = () => selectDisease(d);
                    setupContextTrigger(item, 'disease', d);
                    listContainer.appendChild(item);
                });
                catContainer.appendChild(listContainer);
                els.sidebarContent.appendChild(catContainer);
            });

            // FIX: Allow right-click anywhere in the sidebar background
            els.sidebarContent.oncontextmenu = (e) => {
                if(isAdmin) { 
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY, [
                        { label: 'Add Disease', action: () => openModal('add_disease') },
                        // NEW OPTION
                        { label: 'Import from NotebookLM', action: () => triggerNotebookImport(), style: 'color:#3b82f6;' }
                    ]);
                }
            };
        }

        // --- CORE UI ---
        window.goHome = () => {
            currentModuleId = null;
            els.appView.style.display = 'none';
            els.homeView.style.display = 'flex';
            
            // Fix C & D: Reset App State
            document.body.classList.remove('scrolled');
            document.getElementById('editToggleBtn').classList.remove('edit-btn-mobile-move');
            els.caseDetails.style.display = 'none';
            els.welcomeMsg.style.display = 'block';
        };

        window.toggleRetract = () => {
            if (window.innerWidth <= 768) {
                toggleSidebar(); // Mobile: Open Overlay
            } else {
                els.sidebar.classList.toggle('collapsed'); // PC: Collapse
                const btn = document.getElementById('sidebarToggle');
                if(btn) btn.classList.toggle('collapsed');
            }
        };

        window.toggleSidebar = (forceState) => {
            const isOpen = els.sidebar.style.transform === 'translateX(0px)';
            const shouldOpen = forceState !== undefined ? forceState : !isOpen;
            
            els.sidebar.style.transform = shouldOpen ? 'translateX(0px)' : '';
            document.getElementById('backdrop').style.display = shouldOpen ? 'block' : 'none';
            
            const btn = document.getElementById('sidebarToggle');
            if(btn) {
                if(shouldOpen) btn.classList.add('mobile-open');
                else btn.classList.remove('mobile-open');
            }

            // Fix: Hide FAB on mobile when sidebar is open to prevent collision
            if(window.innerWidth <= 768) {
                const fab = document.getElementById('editorFab');
                if(fab) fab.style.display = shouldOpen ? 'none' : (isEditMode ? 'flex' : 'none');
            }
        };

        function handleScroll(e) {
            const scrollTop = e.target.scrollTop;
            const threshold = 60; // Approx height of header
            
            // Get Elements
            const dName = document.getElementById('detailTitle').innerText;
            const dCat = document.getElementById('detailCat').innerText;
            const editBtn = document.getElementById('editToggleBtn');

            if (scrollTop > threshold) {
                document.body.classList.add('scrolled');
                
                // Update Header Data
                document.getElementById('headerDName').innerText = dName;
                document.getElementById('headerDiseaseCat').innerText = dCat;
                
                // Move Edit Button to Tab Row (Visual Hack)
                // We physically move the DOM node or just use fixed positioning via CSS class
                editBtn.classList.add('edit-btn-mobile-move');
            } else {
                document.body.classList.remove('scrolled');
                editBtn.classList.remove('edit-btn-mobile-move');
            }
        }

        function selectDisease(data) {
            // 1. Save previous state before switching
            if(currentDiseaseId && currentTabId) {
                saveNoteContent(currentDiseaseId);
            }

            currentDiseaseId = data.id;
            currentTabId = null;
            
            // 2. UI Updates
            els.welcomeMsg.style.display = 'none';
            els.caseDetails.style.display = 'flex';
            
            els.detailTitle.innerText = data.name;
            els.detailCat.innerText = data.category;
            document.getElementById('note-title').value = data.name;
            
            renderSidebar();
            loadTabs(data.id);

            if(window.innerWidth <= 768) {
                toggleSidebar(false);
            }

            // 3. FIX: Clean Scroll Logic (No DOM Destruction)
            const contentArea = document.getElementById('contentArea');
            
            // Remove the old listener (safe even if not attached yet)
            contentArea.removeEventListener('scroll', handleScroll);
            
            // Reset Header immediately
            document.querySelector('.app-title').innerText = "IM Disease";
            document.querySelector('.app-title').style.color = "var(--accent-color)";
            
            // Add the new listener
            contentArea.addEventListener('scroll', handleScroll);
        }

        // --- TAB LOGIC ---
        // FIX: Clean up previous listeners to prevent "Double Click" and "Ghost Updates"
        async function loadTabs(diseaseId) {
            // 1. Unsubscribe from the previous disease's tabs (if listening)
            if (tabsUnsubscribe) {
                tabsUnsubscribe();
                tabsUnsubscribe = null;
            }

            const tabsRef = collection(db, "diseases", diseaseId, "tabs");
            const q = query(tabsRef, orderBy("order", "asc"));
            
            // 2. Start new listener and save the unsubscribe function
            tabsUnsubscribe = onSnapshot(q, (snapshot) => {
                const tabs = [];
                snapshot.forEach(doc => tabs.push({id: doc.id, ...doc.data()}));
                
                // 3. LOGIC CHANGE: Allow 0 tabs (Don't auto-create "Notes")
                if(tabs.length === 0) {
                    currentTabId = null;
                    renderTabs([]); // Render just the + button
                    document.getElementById('editor').innerHTML = '<div class="placeholder-text">Click <b>+</b> above to add a Tab</div>';
                } else {
                    tabs.sort((a,b) => (a.order || 0) - (b.order || 0));
                    renderTabs(tabs);
                    
                    // If current tab was deleted, switch to the first available one
                    if(!currentTabId || !tabs.find(t => t.id === currentTabId)) {
                        switchTab(tabs[0]);
                    }
                }
            });
        }
        
        function renderTabs(tabs) {
            const container = els.tabsContainer;
            container.innerHTML = "";
            
            // Create a wrapper specifically for sortable items
            const sortList = document.createElement("div");
            sortList.style.display = "flex";
            sortList.style.gap = "10px";
            sortList.style.overflowX = "auto";
            
            // Enable Sortable ONLY on the wrapper
            if(isAdmin) {
                new Sortable(sortList, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    delay: 300, // Fix A: Increased wait time so taps work reliably
                    delayOnTouchOnly: true,
                    onEnd: (evt) => handleTabReorder(evt)
                });
            }

            tabs.forEach(tab => {
                const btn = document.createElement("div");
                btn.className = `tab-pill ${tab.id === currentTabId ? 'active' : ''}`;
                btn.innerText = tab.title;
                btn.dataset.id = tab.id; 
                btn.onclick = () => switchTab(tab);
                if(isAdmin) {
                    btn.oncontextmenu = (e) => {
                        e.preventDefault();
                        showContextMenu(e.clientX, e.clientY, [
                            { label: 'Rename Tab', action: () => renameTab(tab) },
                            { label: 'Delete Tab', class: 'delete', action: () => deleteTab(tab) }
                        ]);
                    };
                }
                sortList.appendChild(btn);
            });
            
            container.appendChild(sortList);

            // Add Button is OUTSIDE the sortable list
            if(isAdmin) {
                const addBtn = document.createElement("div");
                addBtn.className = "add-tab-btn";
                addBtn.innerText = "+";
                addBtn.style.marginLeft = "10px";
                addBtn.onclick = () => promptAddTab();
                container.appendChild(addBtn);
            }
        }

        async function promptAddTab() {
            const name = prompt("New Tab Name:");
            if(name) addTab(name);
        }

        async function addTab(title, isAuto = false) {
            if(!currentDiseaseId) return;
            const docRef = await addDoc(collection(db, "diseases", currentDiseaseId, "tabs"), {
                title: title, content: "", order: Date.now()
            });
            if(!isAuto) switchTab({id: docRef.id, title: title, content: ""});
        }

        async function renameTab(tab) {
            const newName = prompt("Rename Tab:", tab.title);
            if(newName) await updateDoc(doc(db, "diseases", currentDiseaseId, "tabs", tab.id), { title: newName });
        }

        async function deleteTab(tab) {
            if(confirm(`Delete tab "${tab.title}"?`)) {
                // CRITICAL FIX: Set currentTabId to null so the 'switchTab' logic 
                // knows NOT to try and save this deleted tab.
                if (currentTabId === tab.id) currentTabId = null;
                
                await deleteDoc(doc(db, "diseases", currentDiseaseId, "tabs", tab.id));
            }
        }

        async function switchTab(tab) {
            // Prevent clicking the same tab twice
            if(currentTabId === tab.id) return;
            
            // 1. Critical: Save the OLD tab content before switching
            // Use currentTabId because 'tab' is the NEW destination
            if(currentDiseaseId && currentTabId) {
                await saveNoteContent(currentDiseaseId);
            }

            // 2. Lock the target
            currentTabId = tab.id;
            pendingTabId = tab.id;

            // 3. UI: Update Active Pill Immediately
            const pills = document.querySelectorAll(".tab-pill");
            pills.forEach(p => p.classList.remove("active"));
            for(let p of pills) { 
                if(p.innerText === tab.title) p.classList.add("active"); 
            }

            // 4. Load Data
            try {
                const docRef = doc(db, "diseases", currentDiseaseId, "tabs", tab.id);
                const docSnap = await getDoc(docRef);
                
                // RACE CONDITION CHECK:
                // If the user clicked another tab while this fetch was happening, ABORT.
                if(pendingTabId !== tab.id) return;

                const content = docSnap.exists() ? docSnap.data().content : "";
                
                document.getElementById('editor').innerHTML = content || 
                    '<div class="placeholder-text">Tap Edit <span style="font-style:normal">‚úé</span> then <b>+</b> to add a Clinical Box</div>';
                
                // Re-init editor state
                attachBoxListeners();
                
                // Reset scroll
                document.getElementById('editor').scrollTop = 0;
                
                // Ensure edit mode UI is consistent
                if(isEditMode) {
                    // Re-apply editable attributes if we are in edit mode
                    toggleEditMode(); toggleEditMode(); 
                }
            } catch(err) {
                console.error("Tab Load Error", err);
            }
        }

        // --- EDITOR LOGIC ---
        window.toggleEditMode = () => {
            isEditMode = !isEditMode;
            const toolbar = document.getElementById('editor-toolbar');
            const fab = document.getElementById('editorFab'); 
            const toggleBtn = document.getElementById('editToggleBtn');
            
            if(isEditMode) {
                toolbar.classList.add('visible');
                fab.classList.add('visible'); 
                toggleBtn.classList.add('active');
            } else {
                toolbar.classList.remove('visible');
                fab.classList.remove('visible'); 
                toggleBtn.classList.remove('active');
                if(currentDiseaseId) saveNoteContent(currentDiseaseId);
            }

            const headers = document.querySelectorAll('.box-header-title');
            const bodies = document.querySelectorAll('.box-body');
            const delBtns = document.querySelectorAll('.box-delete-btn');

            headers.forEach(el => el.contentEditable = isEditMode);
            bodies.forEach(el => el.contentEditable = isEditMode);
            delBtns.forEach(btn => btn.style.display = isEditMode ? 'block' : 'none');
        };

        window.insertBox = (color) => {
            const editor = document.getElementById('editor');
            const placeholder = editor.querySelector('.placeholder-text');
            if(placeholder) placeholder.remove();

            const title = prompt("Box Title (e.g. GOLDEN QUESTIONS):");
            if (!title) return;

            const box = document.createElement('div');
            box.className = `clinical-box box-${color}`;

            const header = document.createElement('div');
            header.className = 'box-header';
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'box-header-title';
            titleSpan.innerText = title;
            titleSpan.contentEditable = true;

            const delBtn = document.createElement('button');
            delBtn.className = 'box-delete-btn';
            delBtn.innerHTML = '&times;';
            delBtn.style.display = 'block'; 
            delBtn.onclick = () => {
                if(confirm("Delete this entire box?")) {
                    box.remove();
                    saveNoteContent(currentDiseaseId);
                }
            };

            header.appendChild(titleSpan);
            header.appendChild(delBtn);

            const body = document.createElement('div');
            body.className = 'box-body';
            body.contentEditable = true;
            // Use a div for the content wrapper (Better for arrow keys/Enter)
            body.innerHTML = '<div>Write here...</div>';

            box.appendChild(header);
            box.appendChild(body);

            document.getElementById('editor').appendChild(box);
            body.focus();
            
            if(currentDiseaseId) saveNoteContent(currentDiseaseId);
        };

        window.fmt = (cmd, val) => {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            const anchor = selection.anchorNode;
            const insideBox = anchor && (anchor.nodeType === 3 ? anchor.parentNode : anchor).closest('.box-body');
            if (insideBox) {
                document.execCommand(cmd, false, val);
                insideBox.focus();
            } else {
                if(cmd !== 'undo' && cmd !== 'redo') alert("Please click inside a Box Body to format text.");
            }
        };

        window.insertVideo = () => {
            const selection = window.getSelection();
            const anchor = selection.anchorNode;
            const insideBox = anchor ? (anchor.nodeType === 3 ? anchor.parentNode : anchor).closest('.box-body') : null;
            if (!insideBox) { alert("Click inside a box to insert a video."); return; }

            const url = prompt("YouTube Link:");
            if(url) {
                const match = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
                if(match) {
                    const html = `<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;margin:10px 0;"><iframe src="https://www.youtube.com/embed/${match[1]}" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;"></iframe></div><p><br></p>`;
                    document.execCommand('insertHTML', false, html);
                }
            }
        };

        window.createLink = () => {
            const url = prompt("Enter URL:");
            if(url) window.fmt('createLink', url);
        };

        window.cleanLaTeX = () => {
            const editor = document.getElementById('editor');
            let html = editor.innerHTML;
            html = html.replace(/\\ge/g, '‚â•').replace(/\\le/g, '‚â§').replace(/\\approx/g, '‚âà').replace(/\\pm/g, '¬±')
                .replace(/\\ne/g, '‚â†').replace(/\\times/g, '√ó').replace(/\\rightarrow/g, '‚Üí').replace(/\\leftarrow/g, '‚Üê');
            html = html.replace(/\\text\{([^}]+)\}/g, '$1').replace(/\$/g, ''); 
            html = html.replace(/_\{?(\d+)\}?/g, (m, d) => `<sub>${d}</sub>`).replace(/\^\{?(\d+)\}?/g, (m, d) => `<sup>${d}</sup>`);
            editor.innerHTML = html;
            if(currentDiseaseId) saveNoteContent(currentDiseaseId);
        };

        // --- AUTO-BACKUP SYSTEM (Alpha 0.2.3) ---
        function startAutoBackup() {
            // Run every 5 minutes (300000 ms)
            setInterval(performFullBackup, 300000); 
            console.log("Auto-Backup Service Started");
        }

        async function performFullBackup() {
            if(!isAdmin) return; 
            
            const toast = document.createElement('div');
            toast.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(59,130,246,0.9); color:white; padding:8px 16px; border-radius:20px; font-size:0.8rem; z-index:1000; pointer-events:none;";
            toast.innerText = "‚è≥ Running Auto-Backup...";
            document.body.appendChild(toast);

            try {
                // 1. Fetch Modules
                const modSnap = await getDocs(collection(db, "app_modules"));
                const modules = modSnap.docs.map(d => ({id: d.id, ...d.data()}));

                // 2. Fetch All Diseases & Tabs
                const disSnap = await getDocs(collection(db, "diseases"));
                const diseasesData = [];

                for (const dDoc of disSnap.docs) {
                    const dData = { id: dDoc.id, ...dDoc.data(), tabs: [] };
                    const tabsSnap = await getDocs(collection(db, "diseases", dDoc.id, "tabs"));
                    dData.tabs = tabsSnap.docs.map(t => ({id: t.id, ...t.data()}));
                    diseasesData.push(dData);
                }

                // 3. Save to Local Storage
                const backupPayload = {
                    timestamp: new Date().toISOString(),
                    modules: modules,
                    diseases: diseasesData
                };
                
                localStorage.setItem('IM_AUTO_BACKUP', JSON.stringify(backupPayload));
                
                toast.innerText = "‚úÖ Backup Secured (Local)";
                setTimeout(() => toast.remove(), 2000);
                
            } catch(e) {
                console.error(e);
                toast.innerText = "‚ùå Backup Failed";
                toast.style.background = "rgba(239, 68, 68, 0.9)";
                setTimeout(() => toast.remove(), 3000);
            }
        }

        window.restoreAutoBackup = async () => {
            if(!isAdmin) return;
            const raw = localStorage.getItem('IM_AUTO_BACKUP');
            if(!raw) { alert("No auto-backup found on this device."); return; }
            
            const data = JSON.parse(raw);
            const time = new Date(data.timestamp).toLocaleString();
            
            if(confirm(`‚ö†Ô∏è EMERGENCY RESTORE \n\nRestore data from: ${time}?\n\nThis will OVERWRITE the database. This process takes time.`)) {
                const batch = writeBatch(db);
                let opCount = 0;

                const checkBatch = async () => {
                    opCount++;
                    if(opCount >= 450) { 
                        await batch.commit(); 
                        opCount = 0; 
                        return writeBatch(db); 
                    }
                    return batch;
                };

                // Restore Modules
                for(const m of data.modules) {
                    const ref = doc(db, "app_modules", m.id);
                    batch.set(ref, m);
                    await checkBatch();
                }

                // Restore Diseases & Tabs
                for(const d of data.diseases) {
                    const dRef = doc(db, "diseases", d.id);
                    const dClean = {...d}; 
                    delete dClean.tabs;
                    batch.set(dRef, dClean);
                    await checkBatch();

                    for(const t of d.tabs) {
                        const tRef = doc(db, "diseases", d.id, "tabs", t.id);
                        batch.set(tRef, t);
                        await checkBatch();
                    }
                }

                await batch.commit();
                alert("Restore Complete. Reloading...");
                location.reload();
            }
        };
        
        // --- NEW: Smart Editor Logic ---
        // Ensure "Enter" key creates <div> lines instead of <p> for better navigation
        document.execCommand("defaultParagraphSeparator", false, "div");
        
        function handleEditorKeydown(e) {
            // Image Deletion Logic
            if (e.key === 'Backspace' || e.key === 'Delete') {
                const selectedImg = document.querySelector('.img-wrapper.selected');
                if (selectedImg) {
                    e.preventDefault();
                    selectedImg.remove();
                    if(currentDiseaseId) saveNoteContent(currentDiseaseId);
                    return; 
                }
            }

            // Fix Enter Key: Default to div instead of p for better nesting
            if (e.key === 'Enter' && !e.shiftKey) {
                document.execCommand('defaultParagraphSeparator', false, 'div');
            }
            
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const node = sel.anchorNode;

            // Indent / Outdent
            if (e.key === 'Tab') {
                e.preventDefault();
                document.execCommand(e.shiftKey ? 'outdent' : 'indent');
            }

            // Auto-List Logic (Space trigger)
            if (e.key === ' ' && node.nodeType === 3) {
                const text = node.textContent;
                const offset = sel.anchorOffset;
                
                // Get text strictly before cursor
                const textBefore = text.slice(0, offset); 
                
                if (textBefore.trim() === '1.') {
                    e.preventDefault();
                    // Clean up the trigger text
                    const range = sel.getRangeAt(0);
                    // Find start of the "1."
                    const startPos = textBefore.lastIndexOf('1.');
                    range.setStart(node, startPos);
                    range.setEnd(node, offset);
                    range.deleteContents();
                    document.execCommand('insertOrderedList');
                }
                else if (textBefore.trim() === '-') {
                    e.preventDefault();
                    const range = sel.getRangeAt(0);
                    const startPos = textBefore.lastIndexOf('-');
                    range.setStart(node, startPos);
                    range.setEnd(node, offset);
                    range.deleteContents();
                    document.execCommand('insertUnorderedList');
                }
            }

            // Font Size Hotkeys
            if (e.ctrlKey && e.shiftKey) {
                if (e.key === ',' || e.key === '<') { 
                    e.preventDefault();
                    let current = parseInt(document.queryCommandValue('fontSize')) || 3;
                    if(current > 1) fmt('fontSize', current - 1);
                }
                if (e.key === '.' || e.key === '>') { 
                    e.preventDefault();
                    let current = parseInt(document.queryCommandValue('fontSize')) || 3;
                    if(current < 7) fmt('fontSize', current + 1);
                }
            }
        }

        document.getElementById('editor').addEventListener('keydown', function(e) {
            // General Hotkeys
            if (e.ctrlKey || e.metaKey) {
                const key = e.key.toLowerCase();
                if(key === 'b') { e.preventDefault(); fmt('bold'); }
                if(key === 'i') { e.preventDefault(); fmt('italic'); }
                if(key === 'u') { e.preventDefault(); fmt('underline'); }
            }
            // Pass to smart handler
            handleEditorKeydown(e);
        });

        // Sync Toolbar Active States
        document.addEventListener('selectionchange', () => {
            if (!isEditMode) return;
            const stateMap = {
                'bold': 'btnBold', 'italic': 'btnItalic', 'underline': 'btnUnderline', 'strikeThrough': 'btnStrike',
                'insertUnorderedList': 'btnUL', 'insertOrderedList': 'btnOL',
                'justifyLeft': 'btnAlignLeft', 'justifyCenter': 'btnAlignCenter', 'justifyRight': 'btnAlignRight'
            };
            for (const [cmd, btnId] of Object.entries(stateMap)) {
                const isActive = document.queryCommandState(cmd);
                const btn = document.getElementById(btnId);
                if(btn) {
                    if(isActive) btn.classList.add('active'); else btn.classList.remove('active');
                }
            }
            const size = document.queryCommandValue('fontSize');
            if(size) document.getElementById('fontSizeInp').value = size;
        });

        document.getElementById('editor').addEventListener('input', () => {
             if(currentDiseaseId) {
                 clearTimeout(saveTimeout);
                 saveTimeout = setTimeout(() => saveNoteContent(currentDiseaseId), 1000);
             }
        });

        async function saveNoteContent(diseaseId) {
            if(!currentTabId) return;
            const content = document.getElementById('editor').innerHTML;
            await updateDoc(doc(db, "diseases", diseaseId, "tabs", currentTabId), { 
                content: content, lastUpdated: new Date() 
            });
            const plainText = document.getElementById('editor').innerText;
            await updateDoc(doc(db, "diseases", diseaseId), {
                searchIndex: plainText.substring(0, 1000).toLowerCase() 
            });
        }

        function attachBoxListeners() {
            document.querySelectorAll('.box-delete-btn').forEach(btn => {
                btn.onclick = function() {
                    if(confirm("Delete this entire box?")) {
                        this.closest('.clinical-box').remove();
                        if(currentDiseaseId) saveNoteContent(currentDiseaseId);
                    }
                };
            });
        }

        // --- SEARCH ---
        document.getElementById('searchSidebar').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const container = document.getElementById('sidebarContent');
            if(query.length < 2) { renderSidebar(); return; }

            const results = diseases.filter(d => {
                const nameMatch = d.name.toLowerCase().includes(query);
                const contentMatch = (d.searchIndex || "").includes(query); 
                return nameMatch || contentMatch;
            });

            container.innerHTML = "";
            results.forEach(d => {
                const div = document.createElement("div");
                div.className = "disease-item"; 
                const regex = new RegExp(`(${query})`, 'gi');
                const nameHtml = d.name.replace(regex, "<mark style='background:#3b82f6;color:white'>$1</mark>");
                div.innerHTML = `<div style="font-size:0.8rem;opacity:0.7">${d.category}</div><div>${nameHtml}</div>`;
                div.onclick = () => selectDisease(d);
                container.appendChild(div);
            });
        });

        // --- CONTEXT MENUS & MODALS ---
        function setupContextTrigger(el, type, data) {
            if (!isAdmin) return;
            el.oncontextmenu = (e) => {
                e.preventDefault(); e.stopPropagation();
                showMenuForType(e.clientX, e.clientY, type, data);
            };
            let timer;
            el.addEventListener('touchstart', (e) => {
                timer = setTimeout(() => { showMenuForType(e.touches[0].clientX, e.touches[0].clientY, type, data); }, 200); 
            });
            el.addEventListener('touchmove', () => clearTimeout(timer));
            el.addEventListener('touchend', () => clearTimeout(timer));
        }

        function showMenuForType(x, y, type, data) {
            let items = [];
            if (type === 'module') {
                items = [{ label: 'Edit Section', action: () => openModal('edit_module', data) }, { label: 'Delete', class: 'delete', action: () => deleteItem('app_modules', data.id) }];
            } else if (type === 'disease') {
                items = [{ label: 'Edit Disease', action: () => openModal('edit_disease', data) }, { label: 'Delete', class: 'delete', action: () => deleteItem('diseases', data.id) }];
            }
            showContextMenu(x, y, items);
        }

        function showContextMenu(x, y, items) {
            els.ctxMenu.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = `ctx-item ${item.class || ''}`;
                div.innerText = item.label;
                div.onclick = () => { els.ctxMenu.style.display = 'none'; item.action(); };
                els.ctxMenu.appendChild(div);
            });
            els.ctxMenu.style.display = 'block';
            const w = els.ctxMenu.offsetWidth; const h = els.ctxMenu.offsetHeight;
            if (x + w > window.innerWidth) x -= w;
            if (y + h > window.innerHeight) y -= h;
            els.ctxMenu.style.left = `${x}px`; els.ctxMenu.style.top = `${y}px`;
        }

        document.addEventListener('click', () => els.ctxMenu.style.display = 'none');

        window.openModal = (type, data = {}) => {
            els.modal.style.display = 'flex';
            let html = '', onSave = null;
            if (type.includes('module')) {
                els.modalTitle.innerText = type === 'add_module' ? 'New Section' : 'Edit Section';
                html = `<div class="form-group"><label class="form-label">Title</label><input id="inpTitle" class="form-input" value="${data.title || ''}"></div><div class="form-group"><label class="form-label">Subtitle</label><input id="inpSub" class="form-input" value="${data.subtitle || ''}"></div><div class="form-group"><label class="form-label">Icon (Emoji)</label><input id="inpIcon" class="form-input" value="${data.icon || ''}"></div>`;
                onSave = async () => {
                    const payload = { title: document.getElementById('inpTitle').value, subtitle: document.getElementById('inpSub').value, icon: document.getElementById('inpIcon').value, order: data.order || Date.now() };
                    if(type === 'add_module') await addDoc(collection(db, "app_modules"), payload); else await updateDoc(doc(db, "app_modules", data.id), payload);
                };
            } else {
                els.modalTitle.innerText = type === 'add_disease' ? 'New Disease' : 'Edit Disease';
                const catOptions = categories.map(c => `<option value="${c}">`).join('');
                html = `<div class="form-group"><label class="form-label">Disease Name</label><input id="inpName" class="form-input" value="${data.name || ''}"></div><div class="form-group"><label class="form-label">Category</label><input id="inpCat" class="form-input" list="catList" value="${data.category || ''}"><datalist id="catList">${catOptions}</datalist></div>`;
                onSave = async () => {
                    const payload = { name: document.getElementById('inpName').value, category: document.getElementById('inpCat').value, moduleId: currentModuleId };
                    if(type === 'add_disease') await addDoc(collection(db, "diseases"), payload); else await updateDoc(doc(db, "diseases", data.id), payload);
                };
            }
            els.modalForm.innerHTML = html;
            els.modalSaveBtn.onclick = async () => { await onSave(); window.closeModal(); };
        };

        window.closeModal = () => els.modal.style.display = 'none';

        async function deleteItem(col, id) { if(confirm("Permanently delete?")) await deleteDoc(doc(db, col, id)); }

        async function handleReorder(evt) {
            els.ctxMenu.style.display = 'none';
            const parentGroup = evt.to.closest('.category-group');
            if(!parentGroup) return;
            const newCategory = parentGroup.querySelector('.category-header').innerText;
            const batch = writeBatch(db);
            const listItems = evt.to.querySelectorAll('.disease-item');
            listItems.forEach((el, index) => {
                const id = el.dataset.id;
                if(id) batch.update(doc(db, "diseases", id), { category: newCategory, order: index + 1 });
            });
            await batch.commit();
        }

        els.homeFab.onclick = () => openModal('add_module');

        // --- IMAGE SUPPORT (Google Docs Style) ---
        window.triggerImage = () => document.getElementById('imgUpload').click();

        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => insertImageToBox(e.target.result);
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        };

        // Handle Paste (Ctrl+V)
        document.getElementById('editor').addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.type.indexOf('image') === 0) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => insertImageToBox(event.target.result);
                    reader.readAsDataURL(blob);
                    return;
                }
            }
        });

        function insertImageToBox(src) {
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const anchor = sel.anchorNode;
            const insideBox = anchor && (anchor.nodeType === 3 ? anchor.parentNode : anchor).closest('.box-body');
            
            if (insideBox) {
                // Insert Image Wrapper with Resizer Handle
                const html = `
                    <div class="img-wrapper" style="width: 50%;">
                        <img src="${src}" style="width: 100%;">
                        <div class="img-resizer" onmousedown="initResize(event)"></div>
                    </div><p><br></p>`;
                document.execCommand('insertHTML', false, html);
                if(currentDiseaseId) saveNoteContent(currentDiseaseId);
            } else {
                alert("Click inside a box to insert image.");
            }
        }

        // Click to Select Image
        document.getElementById('editor').addEventListener('click', (e) => {
            // Remove selection from all others
            document.querySelectorAll('.img-wrapper.selected').forEach(el => el.classList.remove('selected'));
            
            const wrapper = e.target.closest('.img-wrapper');
            if (wrapper) {
                wrapper.classList.add('selected');
                // Prevent editing text while resizing image
                wrapper.contentEditable = false; 
            }
        });

        // Drag to Resize Logic
        window.initResize = (e) => {
            e.preventDefault();
            e.stopPropagation(); // Stop editor from losing focus
            
            const resizer = e.target;
            const wrapper = resizer.closest('.img-wrapper');
            const startX = e.clientX;
            const startWidth = wrapper.offsetWidth;
            const parentWidth = wrapper.parentElement.offsetWidth;

            const doDrag = (dragEvent) => {
                const newWidth = startWidth + (dragEvent.clientX - startX);
                // Convert to percentage for responsiveness
                const newPercent = (newWidth / parentWidth) * 100;
                if (newPercent > 10 && newPercent <= 100) {
                    wrapper.style.width = newPercent + '%';
                }
            };

            const stopDrag = () => {
                document.documentElement.removeEventListener('mousemove', doDrag);
                document.documentElement.removeEventListener('mouseup', stopDrag);
                wrapper.contentEditable = true; // Re-enable editing
                if(currentDiseaseId) saveNoteContent(currentDiseaseId);
            };

            document.documentElement.addEventListener('mousemove', doDrag);
            document.documentElement.addEventListener('mouseup', stopDrag);
        };

        // --- DATA MANAGEMENT ---
        window.toggleProfileMenu = () => {
            const menu = document.getElementById('profileMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        };
        // Close menu on outside click
        document.addEventListener('click', (e) => {
            if(!e.target.closest('#userAvatar') && !e.target.closest('#profileMenu')) {
                document.getElementById('profileMenu').style.display = 'none';
            }
        });

        // Toggle FAB options on click
        document.querySelector('.fab-main').onclick = (e) => {
            e.stopPropagation();
            document.getElementById('editorFab').classList.toggle('active');
        };
        // Close FAB when clicking elsewhere
        document.addEventListener('click', (e) => {
            if(!e.target.closest('#editorFab')) {
                document.getElementById('editorFab').classList.remove('active');
            }
        });

        window.exportData = async () => {
            if(!isAdmin) { alert("Admin only."); return; }
            
            // UI Feedback
            const toast = document.createElement('div');
            toast.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#2563eb; color:white; padding:10px 20px; border-radius:20px; z-index:9999; font-size:0.9rem; box-shadow:0 4px 15px rgba(0,0,0,0.3);";
            toast.innerText = "üì¶ Packaging Full Database... (This may take a moment)";
            document.body.appendChild(toast);

            try {
                // 1. Fetch ALL Modules
                const modSnap = await getDocs(collection(db, "app_modules"));
                const modules = modSnap.docs.map(d => ({id: d.id, ...d.data()}));

                // 2. Fetch ALL Diseases
                const disSnap = await getDocs(collection(db, "diseases"));
                const diseasesData = [];

                // 3. Deep Fetch Tabs for EACH Disease
                for (const dDoc of disSnap.docs) {
                    const dData = { id: dDoc.id, ...dDoc.data(), tabs: [] };
                    
                    // Sub-collection Fetch
                    const tabsRef = collection(db, "diseases", dDoc.id, "tabs");
                    const tabsSnap = await getDocs(tabsRef);
                    dData.tabs = tabsSnap.docs.map(t => ({id: t.id, ...t.data()}));
                    
                    diseasesData.push(dData);
                }

                // 4. Construct Final Object
                const exportObj = {
                    version: "0.2.7",
                    exportedAt: new Date().toISOString(),
                    user: auth.currentUser.email,
                    modules: modules,
                    diseases: diseasesData
                };

                // 5. Trigger Download
                const blob = new Blob([JSON.stringify(exportObj, null, 2)], {type : 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `IM_Full_Backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                toast.innerText = "‚úÖ Export Complete! File Downloaded.";
                toast.style.background = "#10b981";
                setTimeout(() => toast.remove(), 3000);

            } catch(e) {
                console.error("Export Error:", e);
                toast.innerText = "‚ùå Export Failed. Check Console.";
                toast.style.background = "#ef4444";
                setTimeout(() => toast.remove(), 4000);
            }
        };

        window.triggerImport = () => document.getElementById('importFile').click();

        // --- NOTEBOOKLM IMPORT SYSTEM ---
        window.triggerNotebookImport = () => document.getElementById('importNotebookFile').click();

        window.handleNotebookImport = (input) => {
            if(!isAdmin) { alert("Admin only."); return; }
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    // Validate Structure
                    if(!data.name || !data.tabs || !Array.isArray(data.tabs)) {
                        alert("Invalid NotebookLM JSON format.");
                        return;
                    }

                    if(confirm(`Import Disease: "${data.name}" into "${data.category || 'General'}"?`)) {
                        const toast = document.createElement('div');
                        toast.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#2563eb; color:white; padding:10px 20px; border-radius:20px; z-index:9999;";
                        toast.innerText = "‚ú® Importing NotebookLM Content...";
                        document.body.appendChild(toast);

                        // 1. Create the Disease Document
                        const diseasePayload = {
                            name: data.name,
                            category: data.category || "Uncategorized",
                            moduleId: currentModuleId, // Adds to current open section
                            searchIndex: data.name.toLowerCase()
                        };
                        
                        const docRef = await addDoc(collection(db, "diseases"), diseasePayload);
                        const newDiseaseId = docRef.id;

                        // 2. Add Tabs (Batch Write for speed)
                        const batch = writeBatch(db);
                        let orderIndex = 1;

                        data.tabs.forEach(tab => {
                            const tabRef = doc(collection(db, "diseases", newDiseaseId, "tabs"));
                            batch.set(tabRef, {
                                title: tab.title,
                                content: tab.content, // HTML generated by Gemini
                                order: orderIndex++
                            });
                        });

                        await batch.commit();

                        toast.innerText = "‚úÖ Import Complete!";
                        toast.style.background = "#10b981";
                        setTimeout(() => {
                            toast.remove();
                            // Optional: Automatically switch to the new disease
                            // selectDisease({id: newDiseaseId, ...diseasePayload}); 
                        }, 2000);
                    }
                } catch(err) {
                    console.error(err);
                    alert("Error parsing JSON: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        };
        
        window.importData = (input) => {
            if(!isAdmin) { alert("Admin only."); return; }
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Basic Validation
                    if(!data.modules || !data.diseases) { 
                        alert("Error: Invalid Backup File Structure."); 
                        input.value = '';
                        return; 
                    }

                    const confirmMsg = `‚ö†Ô∏è FULL IMPORT WARNING\n\nThis will merge/update:\n‚Ä¢ ${data.modules.length} Modules\n‚Ä¢ ${data.diseases.length} Diseases (and all Tabs)\n\nExisting data with the same IDs will be OVERWRITTEN.\n\nAre you sure?`;
                    
                    if(confirm(confirmMsg)) {
                        const toast = document.createElement('div');
                        toast.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#2563eb; color:white; padding:10px 20px; border-radius:20px; z-index:9999; font-size:0.9rem;";
                        toast.innerText = "‚è≥ Importing Data... Do not close.";
                        document.body.appendChild(toast);

                        // Batch Handler to respect Firestore 500-op limit
                        const batchHandler = {
                            batch: writeBatch(db),
                            count: 0,
                            async add(ref, docData) {
                                this.batch.set(ref, docData, {merge: true}); // Merge prevents destroying un-exported fields
                                this.count++;
                                if (this.count >= 450) { 
                                    await this.batch.commit();
                                    this.batch = writeBatch(db);
                                    this.count = 0;
                                }
                            },
                            async flush() { 
                                if (this.count > 0) await this.batch.commit(); 
                            }
                        };

                        // 1. Import Modules
                        for(const m of data.modules) {
                            await batchHandler.add(doc(db, "app_modules", m.id), m);
                        }

                        // 2. Import Diseases & Tabs (Deep Import)
                        for(const d of data.diseases) {
                            // Separate parent data from tab sub-collection data
                            const dClean = {...d}; 
                            delete dClean.tabs; // Don't save the tabs array into the disease doc itself
                            
                            await batchHandler.add(doc(db, "diseases", d.id), dClean);

                            // Restore Tabs Sub-collection
                            if(d.tabs && Array.isArray(d.tabs)) {
                                for(const t of d.tabs) {
                                    await batchHandler.add(doc(db, "diseases", d.id, "tabs", t.id), t);
                                }
                            }
                        }

                        await batchHandler.flush();
                        
                        toast.innerText = "‚úÖ Import Successful! Reloading app...";
                        toast.style.background = "#10b981";
                        setTimeout(() => location.reload(), 1500);
                    }
                } catch(err) { 
                    console.error("Import Error:", err); 
                    alert("Critical Error importing file: " + err.message); 
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input so same file can be selected again
        };
        async function handleTabReorder(evt) {
            const items = evt.to.querySelectorAll('.tab-pill');
            const batch = writeBatch(db);
            items.forEach((el, index) => {
                const id = el.dataset.id;
                // Note: tabs are subcollections, so we construct path carefully
                const tabRef = doc(db, "diseases", currentDiseaseId, "tabs", id);
                batch.update(tabRef, { order: index });
            });
            await batch.commit();
        }
        
    </script>
</body>
</html>
